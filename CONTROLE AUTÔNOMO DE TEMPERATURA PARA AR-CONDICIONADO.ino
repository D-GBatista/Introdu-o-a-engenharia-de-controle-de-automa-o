#include <ZMPT101B.h> //Inclui a biblioteca do sensor de tensão(voltímetro).
#include <IRremote.h> //Inclui a biblioteca do receptor e emissor infravermelho.
#include <DHT11.h> //Inclui a biblioteca do sensor de temperatura.

IRsend irsend;

//Sinais do ar-condicionado na ordem: Ligar, Desligar, Aumentar temperatura e reduzir temperatura
unsigned int on[]={3580, 1520, 596, 1116, 592, 1120, 592, 392, 588, 396, 592, 392, 592, 1116, 596, 392, 592, 392, 592, 1120, 588, 1120, 592, 396, 588, 1120, 592, 392, 592, 396, 588, 1120, 592, 1120, 588, 396, 592, 1116, 592, 1120, 592, 392, 592, 396, 588, 1120, 592, 392, 592, 392, 592, 1120, 592, 392, 592, 392, 592, 392, 592, 396, 588, 396, 592, 392, 592, 396, 588, 396, 588, 396, 588, 396, 592, 392, 592, 392, 592, 396, 588, 396, 588, 396, 592, 392, 592, 396, 588, 1120, 592, 392, 592, 396, 588, 1120, 592, 396, 588, 396, 588, 1120, 592, 1120, 588, 396, 592, 396, 588, 396, 588, 396, 588, 396, 592, 396, 588, 1120, 592, 1116, 592, 396, 588, 1120, 588, 396, 588, 396, 592, 396, 588, 396, 592, 392, 588, 400, 588, 396, 588, 1124, 588, 1120, 592, 1120, 588, 396, 588, 396, 592, 392, 592, 396, 588, 396, 592, 392, 588, 396, 592, 396, 584, 400, 588, 396, 592, 392, 588, 396, 592, 396, 588, 396, 588, 396, 588, 400, 588, 392, 592, 396, 588, 396, 588, 396, 592, 396, 588, 392, 592, 396, 588, 396, 588, 396, 592, 396, 588, 396, 588, 396, 588, 396, 592, 396, 588, 396, 588, 396, 592, 392, 588, 400, 588, 1120, 592, 1120, 588, 1124, 588, 1120, 564, 1148, 588, 1120, 592, 1096, 612, 396, 564, 420, 592};
unsigned int off[]={3576, 1552, 564, 1124, 612, 1100, 588, 396, 588, 420, 592, 396, 588, 1100, 612, 396, 588, 372, 616, 1096, 612, 1096, 616, 396, 592, 1092, 616, 396, 588, 372, 616, 1096, 616, 1116, 592, 372, 616, 1096, 612, 1096, 616, 392, 592, 396, 592, 1092, 616, 396, 588, 396, 588, 1124, 564, 420, 588, 396, 564, 424, 564, 420, 564, 420, 564, 420, 564, 424, 536, 424, 564, 444, 540, 444, 564, 424, 536, 448, 540, 448, 564, 396, 560, 448, 536, 448, 540, 444, 540, 448, 536, 448, 540, 444, 540, 1172, 540, 444, 564, 420, 564, 1152, 564, 1144, 564, 420, 564, 424, 564, 420, 564, 424, 560, 400, 588, 420, 564, 1148, 564, 1148, 564, 420, 564, 1148, 588, 396, 564, 420, 592, 396, 564, 420, 588, 400, 588, 396, 588, 396, 588, 1124, 588, 1124, 588, 1120, 592, 396, 588, 396, 592, 392, 592, 396, 588, 396, 588, 396, 592, 392, 592, 396, 588, 396, 592, 396, 588, 396, 592, 392, 592, 396, 588, 396, 588, 396, 592, 396, 588, 396, 592, 392, 592, 396, 588, 396, 588, 396, 592, 392, 592, 396, 588, 396, 592, 392, 592, 396, 588, 396, 592, 392, 592, 392, 592, 392, 592, 396, 592, 396, 588, 396, 588, 396, 592, 1092, 616, 1124, 588, 396, 592, 1116, 592, 1120, 592, 1120, 592, 1120, 588, 396, 592, 396, 588};
unsigned int mais[]={96, 38804, 3548, 1552, 564, 1148, 564, 1148, 564, 420, 564, 420, 564, 420, 564, 1148, 564, 420, 588, 396, 564, 1148, 588, 1120, 592, 396, 588, 1120, 592, 392, 592, 396, 588, 1120, 592, 1120, 592, 396, 588, 1120, 592, 1116, 592, 396, 592, 392, 592, 1120, 588, 396, 592, 392, 592, 1120, 592, 392, 592, 396, 588, 396, 588, 400, 588, 392, 592, 396, 588, 392, 592, 396, 592, 392, 592, 396, 588, 396, 588, 396, 588, 396, 592, 392, 592, 396, 588, 396, 588, 396, 588, 1124, 588, 396, 588, 396, 592, 1116, 592, 396, 592, 392, 592, 1120, 588, 1124, 588, 396, 588, 396, 592, 396, 588, 396, 588, 396, 588, 396, 592, 396, 588, 1120, 592, 392, 592, 1120, 592, 396, 588, 396, 588, 396, 592, 392, 592, 392, 592, 396, 588, 396, 588, 1120, 592, 1120, 588, 1120, 592, 396, 588, 396, 592, 392, 592, 392, 592, 392, 592, 396, 588, 396, 588, 400, 588, 392, 592, 392, 592, 396, 588, 396, 588, 396, 588, 396, 592, 392, 588, 396, 588, 396, 592, 396, 588, 396, 588, 396, 588, 396, 592, 396, 588, 392, 596, 392, 588, 396, 588, 396, 588, 396, 592, 396, 564, 420, 564, 420, 564, 420, 564, 420, 588, 396, 564, 424, 564, 416, 568, 1144, 564, 1148, 564, 1144, 564, 1148, 564, 1144, 568, 1144, 564, 424, 564, 420, 564};
unsigned int menos[]={3580, 1524, 592, 1120, 592, 1120, 592, 420, 564, 420, 564, 420, 564, 1120, 592, 420, 564, 420, 568, 1080, 632, 1112, 568, 424, 564, 1144, 564, 448, 564, 420, 544, 1168, 540, 1144, 564, 448, 540, 1144, 568, 1144, 564, 420, 592, 396, 588, 1120, 564, 448, 540, 444, 540, 1144, 592, 420, 564, 420, 568, 416, 568, 396, 588, 420, 568, 416, 568, 420, 564, 420, 564, 396, 588, 420, 568, 420, 564, 420, 568, 416, 568, 416, 568, 420, 564, 420, 568, 416, 568, 1116, 596, 416, 572, 416, 568, 1116, 592, 420, 568, 416, 568, 1116, 596, 1140, 568, 420, 568, 416, 568, 416, 568, 420, 568, 416, 568, 416, 568, 1116, 596, 1116, 596, 416, 568, 1120, 592, 416, 568, 420, 564, 420, 568, 416, 568, 420, 564, 420, 568, 416, 568, 1116, 596, 1116, 596, 1116, 592, 420, 568, 416, 568, 416, 568, 416, 572, 416, 568, 416, 568, 416, 572, 412, 568, 420, 568, 416, 568, 420, 568, 416, 568, 416, 568, 420, 564, 420, 568, 416, 568, 420, 568, 420, 564, 416, 568, 416, 568, 420, 568, 416, 568, 416, 568, 416, 568, 420, 564, 420, 568, 416, 568, 416, 568, 416, 568, 416, 572, 416, 568, 416, 568, 420, 568, 416, 568, 1116, 592, 1120, 592, 1116, 596, 1120, 592, 1116, 592, 1144, 568, 1120, 592, 416, 568, 420, 564};

#define SENSITIVITY 489.0f //Define a sensibilidade do sensor de tensão para nossa rede eletrica.
int valortensao = 0; //Variavel que salva o valor lido pelo sensor de tensão.
ZMPT101B voltageSensor(A0, 60.0); // Indica que o sensor de tensão está na porta analogica 0 e a rede eletrica é 60hz.
DHT11 dht11(4); // Indica que o sensor de temperatura está na porta digital 4.
int temperatura=0; // Variavel que salva o valor lido pelo sensor de temperatura.

void setup(){
  voltageSensor.setSensitivity(SENSITIVITY); //Utiliza a sensibilidade definida anteriormente para calibrar o sensor.
  dht11.setDelay(2000); //Estabelece um tempo de 2000ms entre as leituras do sensor de temperatura para evitar erros.
}

void loop() {
  valortensao = getTensao(); //Obtem o valor da tensão utilizando uma função criada, a getTensão.
  while (valortensao > 100){ //Condição que a tensão deve ser maior que 100v, indicando que a lâmpada foi acesa para entrar na estrutura de repetição.
    irsend.sendRaw(on, 229, 38); //Emite sinal infravermelho para ligar o ar-condicionado.
    if (getTensao() < 100){ //Caso a tensão deixe de ser maior que 100v, ou seja, a lâmpada seja desligada, o loop quebra.
    break;
    }
    temperatura = dht11.readTemperature(); //Salva na variavel temperatura o valor lido pelo dht11(sensor de temperatura).
    if(temperatura > 24){ 
      irsend.sendRaw(menos, 250, 38); //Se a temperatura for maior que 24ºC emite o sinal infravermelho referente a redução da temperatura.
      delay(20000);
    }
      
    if(temperatura < 22){
    irsend.sendRaw(mais, 250, 38); //Se a temperatura for menor que 22ºC emite o sinal infravermelho referente ao aumento da temperatura.
    delay(20000);
    }
  }
  irsend.sendRaw(off, 250, 38); //Caso o loop seja quebrado o sinal para desligar o ar-condicionado é emitido.
}

float getTensao(){ //Função getTensao, mede o valor da tensão analisado pelo sensor e retorna na variavel voltage.
  float voltage = voltageSensor.getRmsVoltage();
  return voltage;
}
